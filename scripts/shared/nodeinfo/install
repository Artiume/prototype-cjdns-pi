#!/usr/bin/env bash

set -e

# Add non-static info

echo '"repo":"'"$(git remote get-url origin | awk -F / '{print $5}'| cut -d '.' -f1)"'", "branch":"'"$(git rev-parse --abbrev-ref HEAD)"'", "commit":"'"$(git rev-parse HEAD)"'", "installed":"'"$(date)"'", "uri":"https://github.com/tomeshnet/prototype-cjdns-pi/"},' >> shared/nodeinfo/nodeinfo.json
echo '"key":'"$(cat /etc/cjdroute.conf | jq '.publicKey')"',' >> shared/nodeinfo/nodeinfo.json
echo '"org":'"$MESH_NAME"',' >> shared/nodeinfo/nodeinfo.json
echo '"services":{' >> shared/nodeinfo/nodeinfo.json

# Only adding IPFS for now, more to come later
if [[ "$SUPPORT_IPFS" == "true" ]] && [ ! -z "$WITH_IPFS" -a "$WITH_IPFS" == "true" ]; then
        echo '"ipfs":{"version":"'"$(ipfs --version | awk '{ print $3 }')"'","ID":'"$(ipfs id | jq '.ID')}"

echo '}' >> shared/nodeinfo/nodeinfo.json

echo '}' >> shared/nodeinfo/nodeinfo.json

# Reformat it so it looks nice
cat shared/nodeinfo/nodeinfo.json | jq '.' > shared/nodeinfo/nodeinfo.json

sudo cp nodeinfo.json /var/www/html
